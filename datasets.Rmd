---
title: "Datasets / Données"
output:
  html_document:
    code_folding: show
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = F, echo = TRUE, results = "hide", message = FALSE)
```

## Canadian Demographics by Electoral Riding (1991-2015)

Censuses of Canada are carried out every five years. Since 1991, the census data is available at the level of federal electoral districts. It is thus possible to match these data with parliamentary data (i.e, info on who has been elected in each riding through time). I did this work as part of my doctoral dissertation. Here, I share the process with you. It is heavy in regular expressions and required a lot of back-and-forth between the code and output, so comments are more than welcome on how to improve the end result. 

Because most elections since 1991 happened between census years (1993-1997-2000-2004-2006-2008-2011-2015), I will predict population data in-between census years using imputation in order to obtain demographics on election years. As of now, I focused on the population's age, but I intend to extend this work to other demographic profiles that are available at the level of federal ridings.

There is one important challenge before we start working on matching the censuses with parliamentary data: representation orders changed since the early 1990s. In other words, there has been redistricting. 

- The 1993 election used the 1987 representation order. There were 295 seats in the House of Commons.
- The 1997 and 2000 elections used the 1996 representation order. There were 301 seats.
- The 2004, 2006, 2008 and 2011 elections used the 2003 representation order. There were 308 seats.
- The 2015 election used the 2013 representation order. There are now 338 seats.

Census data are available for the representation orders that come before and after each census. For example, the 1996 census data are provided for 1987 electoral ridings and the 1996 electoral ridings. This is useful, because we can do the imputation for each election year with its true representation order. For example, the 2000 election came between the 1996 and 2001 censuses. We will use these two censuses to find the population values in 2000. Moreover, this election was run under the _1996 r.o._, so we will use the 1996 and 2000 census data that are organized along the _1996 ridings_. On the contrary, we will match the 1996 election data with the 1996 census data under the _1987 r.o._, because this was the representation order in the 1996 election.

Some info on representation orders:

- [Federal electoral districts codes](https://www.elections.ca/content.aspx?section=res&dir=cir/list&document=index338&lang=e)
- [Election Modelling by Byron Weber Becker](http://election-modelling.ca/rawdata/bycandidate/)
- [Legal measures governing changes in federal electoral districts](https://lop.parl.ca/sites/ParlInfo/default/en_CA/legislation/legalMeasuresDistricts)
- [History of the Federal Electoral Ridings, 1867-2010](https://open.canada.ca/data/en/dataset/ea8f2c37-90b6-4fee-857e-984d3060184e)
- [Canada - Elections](https://guides.lib.uwo.ca/canadaelections)
- [Federal electoral district (FED)](https://www12.statcan.gc.ca/census-recensement/2011/ref/dict/geo025-eng.cfm)
- [(Archive 2003-2013) Canada's Federal Electoral Districts](https://www.elections.ca/content.aspx?section=res&dir=cir/list&document=index&lang=e)
- [RO 2013](https://www.elections.ca/content.aspx?section=res&dir=cir/list&document=index338&lang=e)
- [RO 2003](https://www.elections.ca/content.aspx?section=res&dir=cir/list&document=index&lang=e#list)
- [Boundaries](https://open.canada.ca/data/en/dataset?q=%22Federal+Electoral+Districts+of+Canada%22&collection=geogratis&sort=&page=1)

In what follows, we fill 1) recode each census dataset (using the right representation order). In some instance, we will need to recode the same census twice, under two different representation orders (this is the case in 1996, 2001 and 2011) because different r.o. will be used for different parliaments. 2) We will then merge censuses together by representation order. 3) We will impute demographic values for the years that fall in-between census years. 4) We will clean-up the Parliament data, which contains info on MPs elected in the House, their riding, party, gender, etc. 5) Finaly, we will merge the demographics data with the parliament data. There is a LOT of code so I recommend hiding all code (use the button at the top of this page), then showing one chunk at a time as you read this post. You will need these packages to follow along: 

```{r}
library(tidyverse)
library(lubridate)
library(fuzzyjoin) # i'm not even sure I ended up using it, but made a few attempts with this package.
```

### 1) Recoding Censuses by Representation Order

I found the raw census datasets on the [website of Statistics Canada](https://www12.statcan.gc.ca/datasets/index-eng.cfm?Temporal=2016). Selecting "Federal electoral distric" under the "Geography" tab, you will see which census data products are available at the level of ridings. For now, I got the "Age and sex" topic and downloaded every census file available. The older files are available in a weird format (Beyond 20/20). Beyond 20/20 can be used on Windows. I am a Mac user, but opened the files on a Windows machine, then saved them in .csv. If you don't want to go through the hassle, I've made the .csv files available on Github.

I will not be walking you through each dataset recode, but basically we start by reshaping the data from wide to long in order to get an observation for each riding/age combination (for e.g. Rosemont 0 yr old, Rosemont 1 yr old, Rosemont 2yrs old, etc.) This tells us how many people of every age are in each riding. Then, we'll clean-up the names of ridings (remove special characters, etc.) This is where I had to do the most back-and-forth, because some census years used different spellings for the same riding (double dashes instead of single ones, for e.g.), so in the end I needed to change some spellings manually. It's a good thing I had some knowledge about Canadian federal ridings ;)

#### 1991 census (1987 Representation order) 

```{r 1991_1987 recode}

d91 <- read.csv("documentation/data/input/1991census_1987order.csv", sep = ",")

d91_clean <- d91 %>% 
  rename(geo = Géographie,
         sex = Sexe..3.) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick | Nouveau-Brunswick"),
         !str_detect(geo, "Quebec | Québec"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "British Columbia | Colombie-Britannique"),
         !str_detect(geo, "Yukon Territory"),
         !str_detect(geo, "Northwest Territories"),
         !str_detect(geo, "Canada \\(00\\)")) %>% 
  gather(age, value, Total...Groupes.d.âge:X90.et.plus) %>% 
  filter(!str_detect(age, "Total")) %>% 
  mutate(age = str_remove(age, "X")) %>% 
  dplyr::select(geo, age, value)

table(d91_clean$age)

d91_clean <- d91_clean %>%
  mutate(age = ifelse(age == "Moins.de.1", 0, age),
         age = ifelse(age == "90.et.plus", 90, age)) %>% 
  filter(!str_detect(age, "\\."))

table(d91_clean$age)
class(d91_clean$age)

d91_clean <- d91_clean %>% 
  mutate(age = as.numeric(age))

table(d91_clean$age)
class(d91_clean$age)

d91_clean <- d91_clean %>% 
  mutate(census = 1991,
         ro = 1987)

d91_clean <- d91_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)")) %>% 
  unnest(dist_nb) %>% 
  filter(str_detect(dist_nb, "-", negate = TRUE),
         str_detect(dist_nb, "[:alpha:]", negate = TRUE)) %>% 
  mutate(dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  filter(str_detect(dist_nb, " ", negate = TRUE)) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = ifelse(dist_name == "Timiskaming", "Timiskaming-French River", dist_name)) %>% # Timiskaming is called Timiskaming French River in 1996
  select(-geo, -ro) 

length(unique(d91_clean$dist_nb))
length(unique(d91_clean$dist_name))
```

#### 1996 census (1987 Representation order)

```{r 1996_1987 recode}

d96 <- read.csv("documentation/data/input/1996census_1987order.csv", sep = ",")

d96_clean <- d96 %>% 
  rename(geo = Géographie,
         sex = Sexe..3.) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick | Nouveau-Brunswick"),
         !str_detect(geo, "Quebec | Québec"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "British Columbia | Colombie-Britannique"),
         !str_detect(geo, "Yukon Territory"),
         !str_detect(geo, "Northwest Territories"),
         !str_detect(geo, "Canada \\(00\\)")) %>% 
  gather(age, value, Total...Âge:X90.) %>% 
  filter(!str_detect(age, "Total")) %>% 
  mutate(age = str_remove(age, "X")) %>% 
  dplyr::select(geo, age, value)

table(d96_clean$age)

d96_clean <- d96_clean %>%
  mutate(age = ifelse(age == "moins.de.1", 0, age),
         age = ifelse(age == "90.", 90, age)) %>% 
  filter(!str_detect(age, "\\."))

table(d96_clean$age)
class(d96_clean$age)

d96_clean <- d96_clean %>% 
  mutate(age = as.numeric(age))

table(d96_clean$age)
class(d96_clean$age)

d96_clean <- d96_clean %>% 
  mutate(census = 1996,
         ro = 1987)

d96_clean <- d96_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)")) %>% 
  unnest(dist_nb) %>% 
  filter(str_detect(dist_nb, "-", negate = TRUE),
         str_detect(dist_nb, "[:alpha:]", negate = TRUE)) %>% 
  mutate(dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>%
  filter(str_detect(dist_nb, " ", negate = TRUE)) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both")) %>%
  select(-geo,-ro)

length(unique(d96_clean$dist_nb))
length(unique(d96_clean$dist_name))
```

#### 1996 census (1996 Representation order)

```{r 1996_1996 recode}

d96_2 <- read.csv("documentation/data/input/1996census_1996order.csv", sep = ",")

d96_2_clean <- d96_2 %>% 
  rename(geo = Géographie,
         sex = Sexe..3.) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick | Nouveau-Brunswick"),
         !str_detect(geo, "Quebec | Québec"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "British Columbia | Colombie-Britannique"),
         !str_detect(geo, "Yukon Territory"),
         !str_detect(geo, "Northwest Territories"),
         !str_detect(geo, "Canada \\(00\\)")) %>% 
  gather(age, value, Total...Âge:X90.) %>% 
  filter(!str_detect(age, "Total")) %>% 
  mutate(age = str_remove(age, "X")) %>% 
  dplyr::select(geo, age, value)

table(d96_2_clean$age)

d96_2_clean <- d96_2_clean %>%
  mutate(age = ifelse(age == "moins.de.1", 0, age),
         age = ifelse(age == "90.", 90, age)) %>% 
  filter(!str_detect(age, "\\."))

table(d96_2_clean$age)
class(d96_2_clean$age)

d96_2_clean <- d96_2_clean %>% 
  mutate(age = as.numeric(age))

table(d96_2_clean$age)
class(d96_2_clean$age)

d96_2_clean <- d96_2_clean %>% 
  mutate(census = 1996,
         ro = 1996)

d96_2_clean <- d96_2_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)"),
         dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = str_replace_all(dist_name, " / ", "/")) %>%
  select(-geo, -ro) 

length(unique(d96_2_clean$dist_nb))
length(unique(d96_2_clean$dist_name))
```

#### 2001 census (1996 Representation order)

```{r 2001_1996 recode}

d01 <- read.csv("documentation/data/input/2001census_1996order.csv", encoding = "latin1")
summary(d01)

d01_clean <- d01 %>% 
  rename(geo = Géographie,
         sex = `Sexe..3.`) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick - Nouveau-Brunswick \\(13\\)"),
         !str_detect(geo, "Québec \\(24\\)"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "British Columbia | Colombie-Britannique"),
         !str_detect(geo, "Yukon Territory"),
         !str_detect(geo, "Northwest Territories"),
         !str_detect(geo, "Canada"),
         !str_detect(geo, "Nunavut \\(62\\)")) %>% 
  gather(age, value, `Total...Âge`:`X100.`) %>% 
  filter(!str_detect(age, "Total")) %>% 
  dplyr::select(geo, age, value)

table(d01_clean$age)

d01_clean <- d01_clean %>%
  mutate(age = ifelse(age == "Moins.de.1.an", 0, age),
         age = ifelse(age == "X100.", 100, age),
         age = str_remove_all(age, "X")) %>% 
  filter(!str_detect(age, "\\."))

table(d01_clean$age)
class(d01_clean$age)

d01_clean <- d01_clean %>% 
  mutate(age = as.numeric(age))

table(d01_clean$age)
class(d01_clean$age)

d01_clean <- d01_clean %>% 
  mutate(census = 2001,
         ro = 1996)

d01_clean <- d01_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)"),
         dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = str_replace_all(dist_name, " / ", "/")) %>%
  select(-geo, -ro) 

length(unique(d01_clean$dist_nb))
length(unique(d01_clean$dist_name))
```

#### 2001 census (2003 Representation order)

```{r 2001_2003 recode}

d01_2 <- read.csv("documentation/data/input/2001census_2003order.csv", encoding = "latin1")
summary(d01_2)

d01_2_clean <- d01_2 %>% 
  rename(geo = Géographie,
         sex = `Sexe..3.`) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick - Nouveau-Brunswick \\(13\\)"),
         !str_detect(geo, "Québec \\(24\\)"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "British Columbia | Colombie-Britannique"),
         !str_detect(geo, "Yukon Territory"),
         !str_detect(geo, "Northwest Territories"),
         !str_detect(geo, "Canada"),
         !str_detect(geo, "Nunavut \\(62\\)")) %>% 
  gather(age, value, `Total...Âge`:`X100.`) %>% 
  filter(!str_detect(age, "Total")) %>% 
  dplyr::select(geo, age, value)

table(d01_2_clean$age)

d01_2_clean <- d01_2_clean %>%
  mutate(age = ifelse(age == "Moins.de.1.an", 0, age),
         age = ifelse(age == "X100.", 100, age)) %>% 
  mutate(age = str_remove(age, "ans"),
         age = str_remove(age, "an")) %>% 
  filter(!str_detect(age, "\\.1"),
         !str_detect(age, "\\.2"),
         !str_detect(age, "\\.3"),
         !str_detect(age, "\\.4"),
         !str_detect(age, "\\.5"),
         !str_detect(age, "\\.6"),
         !str_detect(age, "\\.7"),
         !str_detect(age, "\\.8"),
         !str_detect(age, "\\.9")) %>% 
  mutate(age = str_remove(age, "X"),
         age = str_remove(age, "\\."))

table(d01_2_clean$age)
class(d01_2_clean$age)

d01_2_clean <- d01_2_clean %>% 
  mutate(age = as.numeric(age))

table(d01_2_clean$age)
class(d01_2_clean$age)

d01_2_clean <- d01_2_clean %>% 
  mutate(census = 2001,
         ro = 2003)

d01_2_clean <- d01_2_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)"),
         dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "/"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = str_replace_all(dist_name, " / ", "/")) %>%
  select(-geo, -ro) 

length(unique(d01_2_clean$dist_nb))
length(unique(d01_2_clean$dist_name))
```

#### 2006 census (2003 Representation order)

```{r 2006_2003 recode}

d06 <- read.csv("documentation/data/input/2006census_2003order.csv", encoding = "latin1")
summary(d06)

d06_clean <- d06 %>% 
  rename(geo = Géographie,
         sex = `Sexe..3.`) %>% 
  select(-`Âge.médian`) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick / Nouveau-Brunswick \\(13\\)"),
         !str_detect(geo, "Québec \\(24\\)"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "Colombie-Britannique \\(59\\)"),
         !str_detect(geo, "Yukon Territory"),
         !str_detect(geo, "Northwest Territories"),
         !str_detect(geo, "Canada"),
         !str_detect(geo, "Nunavut \\(62\\)")) %>% 
  gather(age, value, `Total...Âge`:`X100.ans.et.plus`) %>% 
  filter(!str_detect(age, "Total")) %>% 
  dplyr::select(geo, age, value)

table(d06_clean$age)

d06_clean <- d06_clean %>%
  mutate(age = ifelse(age == "Moins.de.1.an", 0, age),
         age = ifelse(age == "X100.ans.et.plus", 100, age),
         age = str_remove_all(age, "X")) %>% 
  filter(!str_detect(age, "ans"))

table(d06_clean$age)
class(d06_clean$age)

d06_clean <- d06_clean %>% 
  mutate(age = as.numeric(age))

table(d06_clean$age)
class(d06_clean$age)

d06_clean <- d06_clean %>% 
  mutate(census = 2006,
         ro = 2003)

d06_clean <- d06_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)"),
         dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = str_replace_all(dist_name, " / ", "/")) %>%
  select(-geo, -ro) 

length(unique(d06_clean$dist_nb))
length(unique(d06_clean$dist_name))

```

#### 2011 census (2003 Representation order)

```{r 2011_2003 recode}

d11 <- read.csv("documentation/data/input/2011census_2003order.csv", encoding = "latin1")
summary(d11)

d11_clean <- d11 %>% 
  rename(geo = Géographie,
         sex = `Sexe..3.`) %>% 
  select(-`Âge.médian`) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick / Nouveau-Brunswick \\(13\\)"),
         !str_detect(geo, "Quebec | Québec"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "Colombie-Britannique \\(59\\)"),
         !str_detect(geo, "Yukon \\(60\\)"),
         !str_detect(geo, "Northwest Territories"),
         !str_detect(geo, "Canada"),
         !str_detect(geo, "Nunavut \\(62\\)")) %>% 
  gather(age, value, `Total...Âge`:`X100.ans.et.plus`) %>% 
  filter(!str_detect(age, "Total")) %>% 
  dplyr::select(geo, age, value)

table(d11_clean$age)

d11_clean <- d11_clean %>%
  mutate(age = ifelse(age == "Moins.de.1.an", 0, age),
         age = ifelse(age == "X100.ans.et.plus", 100, age),
         age = str_remove(age, "X")) %>% 
  filter(!str_detect(age, "ans")) 

table(d11_clean$age)
class(d11_clean$age)

d11_clean <- d11_clean %>% 
  mutate(age = as.numeric(age))

table(d11_clean$age)
class(d11_clean$age)

d11_clean <- d11_clean %>% 
  mutate(census = 2011,
         ro = 2003)

d11_clean <- d11_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)"),
         dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = str_replace_all(dist_name, " / ", "/")) %>%
  select(-geo, -ro) 

length(unique(d06_clean$dist_nb))
length(unique(d06_clean$dist_name))

```

#### 2011 census (2013 Representation order)

```{r 2011_2013 recode}

d11_2 <- read.csv("documentation/data/input/2011census_2013order.csv", encoding = "latin1")
summary(d11_2)

d11_2_clean <- d11_2 %>% 
  rename(geo = Géographie,
         sex = `Sexe..3.`) %>% 
  select(-`Âge.médian`) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick / Nouveau-Brunswick \\(13\\)"),
         !str_detect(geo, "Quebec | Québec"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan \\(47\\)"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "Colombie-Britannique \\(59\\)"),
         !str_detect(geo, "Yukon \\(60\\)"),
         !str_detect(geo, "Northwest Territories / Territoires du Nord-Ouest \\(61\\)"),
         !str_detect(geo, "Canada"),
         !str_detect(geo, "Nunavut \\(62\\)")) %>% 
  gather(age, value, `Total...Âge`:`X100.ans.et.plus`) %>% 
  filter(!str_detect(age, "Total")) %>% 
  dplyr::select(geo, age, value)

table(d11_2_clean$age)

d11_2_clean <- d11_2_clean %>%
  mutate(age = ifelse(age == "Moins.de.1.an", 0, age),
         age = ifelse(age == "X100.ans.et.plus", 100, age),
         age = str_remove(age, "X")) %>% 
  filter(!str_detect(age, "ans"))

table(d11_2_clean$age)
class(d11_2_clean$age)

d11_2_clean <- d11_2_clean %>% 
  mutate(age = as.numeric(age))

table(d11_2_clean$age)
class(d11_2_clean$age)

d11_2_clean <- d11_2_clean %>% 
  mutate(census = 2011,
         ro = 2013)

d11_2_clean <- d11_2_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)"),
         dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = str_replace_all(dist_name, " / ", "/")) %>%
  select(-geo, -ro) 

length(unique(d11_2_clean$dist_nb))
length(unique(d11_2_clean$dist_name))

```

#### 2016 census (2013 Representation order)

```{r 2016_2013 recode}

d16 <- read.csv("documentation/data/input/2016census_2013order.csv", encoding = "latin1")
summary(d16)

d16_clean <- d16 %>% 
  rename(geo = Géographie,
         sex = `Sexe..3.`) %>% 
  select(-`Âge.moyen`) %>% 
  filter(str_detect(geo, "[:alpha:]"),
         str_detect(sex, "Total"),
         !str_detect(geo, "Newfoundland | Terre-Neuve"),
         !str_detect(geo, "Prince Edward Island | Île-du-Prince-Édouard"),
         !str_detect(geo, "Nova Scotia | Nouvelle-Écosse"),
         !str_detect(geo, "New Brunswick / Nouveau-Brunswick \\(13\\)"),
         !str_detect(geo, "Quebec | Québec"),
         !str_detect(geo, "Ontario \\(35\\)"),
         !str_detect(geo, "Saskatchewan \\(47\\)"),
         !str_detect(geo, "Manitoba"),
         !str_detect(geo, "Alberta"),
         !str_detect(geo, "Colombie-Britannique \\(59\\)"),
         !str_detect(geo, "Yukon \\(60\\)"),
         !str_detect(geo, "Northwest Territories / Territoires du Nord-Ouest \\(61\\)"),
         !str_detect(geo, "Canada"),
         !str_detect(geo, "Nunavut \\(62\\)")) %>% 
  gather(age, value, `Total...Âge`:`X100.ans.et.plus`) %>% 
  filter(!str_detect(age, "Total")) %>% 
  dplyr::select(geo, age, value)

table(d16_clean$age)

d16_clean <- d16_clean %>%
  mutate(age = ifelse(age == "Moins.de.1.an", 0, age),
         age = ifelse(age == "X100.ans.et.plus", 100, age),
         age = str_remove(age, "X")) %>% 
  filter(!str_detect(age, "ans"))

table(d16_clean$age)
class(d16_clean$age)

d16_clean <- d16_clean %>% 
  mutate(age = as.numeric(age))

table(d16_clean$age)
class(d16_clean$age)

d16_clean <- d16_clean %>% 
  mutate(census = 2016,
         ro = 2013)

d16_clean <- d16_clean %>% 
  mutate(dist_name = str_remove_all(geo, "[0-9]+"),
         dist_name = str_remove_all(dist_name, "\\(.*\\)"),
         dist_nb = str_extract_all(geo, "\\([^()]+\\)")) %>% 
  unnest(dist_nb) %>% 
  filter(str_detect(dist_nb, "%", negate = TRUE)) %>% 
  mutate(dist_nb = str_extract_all(dist_nb, "(?<=\\().+?(?=\\))")) %>% 
  unnest(dist_nb) %>% 
  mutate(dist_name = str_replace_all(dist_name, " - ", "-"),
         dist_name = str_replace_all(dist_name, " -", "-"),
         dist_name = str_replace_all(dist_name, "- ", "-"),
         dist_name = str_replace_all(dist_name, "--", "-"),
         dist_name = str_trim(dist_name, side = "both"),
         dist_name = str_replace_all(dist_name, " / ", "/"),
         dist_name = str_replace_all(dist_name, " /", "/")) %>%
  select(-geo, -ro) 

length(unique(d16_clean$dist_name))
length(unique(d16_clean$dist_nb))

```


### 2) Merging Censuses Together by Representation Order

Here, we will merge dataframes from the same representation orders. For example, we need to merge the 1991 and 1996 census that use both the 1987 r.o. in order to be able (later) to make the value imputation for 1992-1993-1994-1995, which all used the 1987 r.o. At this step, there was, yet again, some spelling differences. This made my head want to explode, but I managed to reach the expected result !

#### Merge 1991 census (1987 Representation order) with 1996 census (1987 Representation order) to map with _1993 parliament data._
```{r match ro1987}

d91_clean <- d91_clean %>% 
  spread(age, value)
d96_clean <- d96_clean %>% 
  spread(age, value)

ro1987 <- rbind(d91_clean, d96_clean) %>% 
  gather(age, value, `0`:`90`) %>% 
  spread(census, value) 

length(unique(ro1987$dist_nb))
length(unique(ro1987$dist_name))
check <- ro1987 %>% 
  filter(is.na(`1991`) == TRUE |
           is.na(`1996`) == TRUE) # all good

```

#### Merge 1996 census (1996 Representation order) with 2001 census (1996 Representation order) to map with _1997 parliament data_ and _2000 parliament data._

```{r match ro1996}

d96_2_clean <- d96_2_clean %>% 
  spread(age, value)

# I have to merge 90+ yo categories because previous census does not have 90-100 y.o.
# it creates problems when merging
d01_clean <- d01_clean %>% 
  spread(age, value) %>% 
  unnest(dist_nb) %>%  # dist_nb was a list
  dplyr::group_by(dist_nb) %>% 
  mutate(`90+` = `90` + `91` + `92` +`93` +`94` +`95` +`96` +`97` +`98` +`99` +`100`) %>% 
  ungroup() %>% 
  select(-`90`, -`91`, -`92`, -`93`, -`94`,
         -`95`, -`96`, -`97`, -`98`, -`99`, -`100`) %>% 
  rename(`90` = `90+`) # ok, all set

ro1996 <- rbind(d96_2_clean, d01_clean) %>% 
  gather(age, value, `0`:`90`) %>% 
  spread(census, value)

length(unique(ro1996$dist_nb))
check <- ro1996 %>% 
  filter(is.na(`1996`) == TRUE |
           is.na(`2001`) == TRUE)

# Nunavut is 61001 in 1996 and 62001 in 2001. I will merge them.
ro1996 <- ro1996 %>% 
  gather(year, value, `1996`:`2001`) %>% 
  spread(age, value) %>% 
  mutate(dist_nb = ifelse(dist_nb == "62001" & year == "2001", "61001", dist_nb)) %>% 
  drop_na() %>% 
  gather(age, value, `0`:`90`) %>% 
  spread(year, value)

check <- ro1996 %>% 
  filter(is.na(`1996`) == TRUE |
           is.na(`2001`) == TRUE) 

list <- check %>% distinct(dist_name, dist_nb)

# Fix different spellings
ro1996 <- ro1996 %>% 
  gather(year, value, `1996`:`2001`) %>%
  unnest(dist_nb) %>%
  drop_na() %>%
  dplyr::group_by(dist_nb, age) %>%
  mutate(new_name = dist_name[year == 1996]) %>% # recode districts with different names to their 1996 names -- this does not mean they're different districts (they have the same nb), it is because Statistics Canada used different names for the same representation order. This is going to cause some trouble later, but we will fix it.
  dplyr::ungroup() %>%
  mutate(dist_name = new_name) %>% 
  select(-new_name) %>%
  spread(year, value)

check <- ro1996 %>% 
  filter(is.na(`1996`) == TRUE |
           is.na(`2001`) == TRUE)

length(unique(ro1996$dist_name))
length(unique(ro1996$dist_nb))

```

#### Merge 2001 census (2003 Representation order) with 2006 census (2003 Representation order) to map with _2004 parliament data._

```{r match ro2003}

d01_2_clean <- d01_2_clean %>% 
  spread(age, value)
d06_clean <- d06_clean %>% 
  spread(age, value)
ro2003 <- rbind(d01_2_clean, d06_clean) %>% 
  gather(age, value, `0`:`100`) %>% 
  spread(census, value)

ro2003 <- ro2003 %>% 
  gather(year, value, `2001`:`2006`) %>% 
  drop_na() %>% 
  dplyr::group_by(dist_nb, age) %>% 
  mutate(new_name = dist_name[year == 2001]) %>% # recode districts with different names in 2001 and 2006 
  dplyr::ungroup() %>% 
  mutate(dist_name = new_name) %>% 
  select(-new_name) %>%  
  spread(year, value)

length(unique(ro2003$dist_nb))
length(unique(ro2003$dist_name))

check <- ro2003 %>% 
  filter(is.na(`2001`) == TRUE |
           is.na(`2006`) == TRUE)

```

And map 2006 census (2003 Representation order) with _2006 parliament data._

#### Merge 2006 census (2003 Representation order) with 2011 census (2003 Representation order) to map with _2008 parliament data._

```{r match ro2003_2}

d11_clean <- d11_clean %>% 
  spread(age, value)
ro2003_2 <- rbind(d06_clean, d11_clean) %>% 
  gather(age, value, `0`:`100`) %>% 
  spread(census, value)

length(unique(ro2003_2$dist_nb))
length(unique(ro2003_2$dist_name))

check <- ro2003_2 %>% 
  filter(is.na(`2006`) == TRUE |
           is.na(`2011`) == TRUE)

```

And map 2011 census (2003 Representation order) with _2011 parliament data._

#### Merge 2011 census (2013 Representation order) 2016 census (2013 Representation order) to map with _2015 parliament data._ 

```{r match ro2013}
d11_2_clean <- d11_2_clean %>% 
  spread(age, value)
d16_clean <- d16_clean %>% 
  spread(age, value)

ro2013 <- rbind(d11_2_clean, d16_clean) %>% 
  gather(age, value, `0`:`100`) %>% 
  spread(census, value)

length(unique(ro2013$dist_nb))
check <- ro2013 %>% 
  filter(is.na(`2011`) == TRUE |
           is.na(`2016`) == TRUE) # oops

ro2013 <- ro2013 %>% 
  gather(year, value, `2011`:`2016`) %>% 
  drop_na() %>% 
  dplyr::group_by(dist_nb, age) %>% 
  mutate(new_name = dist_name[year == 2011]) %>% #recode districts with different names, use 2011 names
  dplyr::ungroup() %>% 
  mutate(dist_name = new_name) %>% 
  select(-new_name) %>% 
  spread(year, value) 

length(unique(ro2013$dist_nb))
length(unique(ro2013$dist_name))
check <- ro2013 %>% 
  filter(is.na(`2011`) == TRUE |
           is.na(`2016`) == TRUE) # all good

```

### 3) Imputation of Values for Years In-Between Censuses

Election years sometimes (often) fall in-between censuses. We will interpolate the number of people in each age group to years between censuses, so that we have 'truer' values for election years. We will do this for each of the five datasets we have merged in the previous step. 

First, we need to reshape the data from long to wide.

```{r}
ro1987_imputation <- ro1987 %>% 
  gather(year, value, `1991`:`1996`) %>% 
  mutate(year = as.integer(year)) %>% 
  mutate(ro = "ro1987")

ro1996_imputation <- ro1996 %>% 
  gather(year, value, `1996`:`2001`) %>% 
  mutate(year = as.integer(year)) %>% 
  mutate(ro = "ro1996")

ro2003_imputation <- ro2003 %>% 
  gather(year, value, `2001`:`2006`) %>% 
  mutate(year = as.integer(year)) %>% 
  mutate(ro = "ro2003")

ro2003_2_imputation <- ro2003_2 %>% 
  gather(year, value, `2006`:`2011`) %>% 
  mutate(year = as.integer(year)) %>% 
  mutate(ro = "ro2003_2")

ro2013_imputation <- ro2013 %>% 
  gather(year, value, `2011`:`2016`) %>% 
  mutate(year = as.integer(year)) %>% 
  mutate(ro = "ro2013")

imputation_d <- rbind(ro1987_imputation, ro1996_imputation, ro2003_imputation, ro2003_2_imputation, ro2013_imputation)
```

Then, we make the value imputation. This is a function I found online. It seems to work well, but suggestions as to how to do this otherwise would be more than welcome (is there a built-in function or package achieving this with fewer lines of code?).

```{r}
expand_data <- function(x) {
  years <- min(imputation_d$year):max(imputation_d$year)
  btw_years <- 1
  grid <- expand.grid(btw_year = btw_years, year = years)
  x$btw_year <- 1
  merged <- grid %>% left_join(x, by = c('year', 'btw_year'))
  merged$dist_name <- x$dist_name[1]
  merged$dist_nb <- x$dist_nb[1]
  merged$age <- x$age[1]
  merged$ro <- x$ro[1]
  return(merged)
}

interpolate_data <- function(data) {
  xout <- 1:nrow(data)
  y <- data$value
  interpolation <- approx(x = xout[!is.na(y)], y = y[!is.na(y)], xout = xout)
  data$yhat <- interpolation$y
  return(data)
}

expand_and_interpolate <- function(x) interpolate_data(expand_data(x))

imputation_data <- imputation_d %>% group_by(dist_name, dist_nb, age, ro) %>% do(expand_and_interpolate(.))

print(as.data.frame(imputation_data))

imputation_data2 <- imputation_data %>% 
  mutate(value = yhat) %>% 
  select(-yhat, -btw_year) %>% 
  drop_na() %>% 
  ungroup()

table(imputation_data2$ro, imputation_data2$year)
table(imputation_data2$dist_nb, imputation_data2$ro)
table(imputation_data2$age, imputation_data2$year)
```

What to do with post-2016? We cannot make value imputation for these years because they come after the last census. The next-best option would be to use the 2016 values for every year after 2016, but we would be loosing some variation in the demography.

### 4) Cleaning-Up the Parliament (MP) Data

We will merge the names of districts in each representation order with the names of districts in each Parliament (34th to 42nd). The goal is to build a dataset of electoral ridings in each election year associated with the names and birth dates of Members of each parliament _and_ the demographic distribution of the population in each district.

I downloaded each Parliament datasets from the [Library of Parliament website](https://lop.parl.ca/sites/ParlInfo/default/en_CA/People/parliamentarians). I could have extracted all Parliaments at once, but wanted to do it one by one to make sure the clean-up process ran smoothly. The data is in somewhat of a weird format: each parliamentarian takes a different row, with variables (columns) for his/her date of birth, type of work (MP or Senator), constituency(ies) (with accompanying dates), party affiliation(s), etc. What is most interesting to me is the MP's name and constituency. I have to separate the constituency column, because it contains all the constituencies each MP has ever served in. My goal is to (1) divide this column to find all constituencies a given MP has served, then (2) delete those that do not correspond to the Parliament I'm looking at. For example, for the 35th Parliament, I keep constituencies where members served between 25 October 1993 and 27 April 1997 only. The process is pretty much the same for each Parliament, so the code is commented for the first one only. 

#### 34th Parliament MPs (1988 election and by-elections)

```{r}
parl34 <-  read.csv("documentation/data/input/parl_34.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "1988-11-21" & riding_start_date <= "1993-09-08") %>%  # keep only those that end after the election (Nov 21, 1988) and those that start before the end of the 34th parliament (Sept 8, 1993)
  select(-type_date, -province, -riding, -type) %>% # remove unecessary variables
  mutate(year = 1991) %>% # I call it 1991 because that's when the census was done
  group_by(name) %>% # next lines remove MP who are found twice because their district changed name during the 34th parliament (even if there hasn't been resdistricting)
  arrange(desc(riding_start_date), .by_group = TRUE) %>% 
  slice(1) %>% 
  ungroup()

length(unique(parl34$name))
length(unique(parl34$dist_name)) 
summary(parl34)
```

#### 35th Parliament MPs (1993 election and by-elections)

```{r}
parl35 <-  read.csv("documentation/data/input/parl_35.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "1993-10-25" & riding_start_date <= "1997-04-27") %>%  # keep only those that end after the election (October 25, 1993) and those that start before the end of the 35th parliament (April 27, 1997)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>% # remove unecessary variables
  mutate(year = 1993)

length(unique(parl35$name))
length(unique(parl35$dist_name)) 
summary(parl35)
```

#### 36th Parliament MPs (1997 election and by-elections)

```{r}
parl36 <-  read.csv("documentation/data/input/parl_36.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "1997-06-02" & riding_start_date <= "2000-10-22") %>%  # keep only those that end after the election (June 2, 1997) and those that start before the end of the 35th parliament (October 22, 2000)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>% # remove unecessary variables
  mutate(year = 1997)
  
length(unique(parl36$name))
summary(parl36)
length(unique(parl36$dist_name)) # some have the names of the following representation order because MPs stayed a longer time in office. I have to recode them to the 1996 names

parl36 <- parl36 %>% 
  arrange(riding_start_date) %>% 
  dplyr::group_by(name, birth) %>% 
  filter(row_number() == 1)

length(unique(parl36$dist_name))
length(unique(parl36$name))
```

#### 37th Parliament MPs (2000 election and by-elections)

```{r}
parl37 <-  read.csv("documentation/data/input/parl_37.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "2000-11-27" & riding_start_date <= "2004-05-23") %>%  # keep only those that end after the election (November 27, 2000) and those that start before the end of the 35th parliament (May 23, 2004)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>%  # remove unecessary variables
  mutate(year = 2000)

length(unique(parl37$name))
summary(parl37)
length(unique(parl37$dist_name)) 
```

#### 38th Parliament MPs (2004 election and by-elections)

```{r}
parl38 <-  read.csv("documentation/data/input/parl_38.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "2004-06-28" & riding_start_date <= "2005-11-29") %>%  # keep only those that end after the election (June 28, 2004) and those that start before the end of the 35th parliament (November 29, 2005)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>% # remove unecessary variables
  mutate(year = 2004)
  
length(unique(parl38$name))
summary(parl38)
length(unique(parl38$dist_name)) # some have the names of the following representation order because MPs stayed a longer time in office. I have to recode them to the 2003 names

parl38 <- parl38 %>% 
  arrange(riding_start_date) %>% 
  dplyr::group_by(name, birth) %>% 
  filter(row_number() == 1)

length(unique(parl38$dist_name))
length(unique(parl38$name))
```

#### 39th Parliament MPs (2006 election and by-elections)

```{r}
parl39 <-  read.csv("documentation/data/input/parl_39.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "2006-01-23" & riding_start_date <= "2008-09-07") %>%  # keep only those that end after the election (January 23, 2006) and those that start before the end of the 35th parliament (September 7, 2008)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>% # remove unecessary variables
  mutate(year = 2006)
  
length(unique(parl39$name))
summary(parl39)
length(unique(parl39$dist_name))
```

#### 40th Parliament MPs (2008 election and by-elections)

```{r}
parl40 <-  read.csv("documentation/data/input/parl_40.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "2008-11-14" & riding_start_date <= "2011-03-26") %>%  # keep only those that end after the election (October 14, 2008) and those that start before the end of the 35th parliament (March 26, 2011)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>% # remove unecessary variables
  mutate(year = 2008)
  
length(unique(parl40$name))
summary(parl40)
length(unique(parl40$dist_name))
```

#### 41st Parliament MPs (2011 election and by-elections)

```{r}
parl41 <-  read.csv("documentation/data/input/parl_41.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "2011-05-02" & riding_start_date <= "2015-08-15") %>%  # keep only those that end after the election (May 2, 2011) and those that start before the end of the 35th parliament (August 2, 2015)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>%  # remove unecessary variables
  mutate(year = 2011)
  
length(unique(parl41$name))
summary(parl41)
length(unique(parl41$dist_name))
```

#### 42nd Parliament MPs (2015 election and by-elections)

```{r}
parl42 <-  read.csv("documentation/data/input/parl_42.csv", sep = ";") %>% 
  mutate(type = Type.of.Parliamentarian, # rename
         riding = Riding.Senatorial.Division, 
         name = Name, 
         birth = Date.of.Birth, 
         province = Province.Territory, 
         gender = Gender, 
         pid = Political.Affiliation,
         type = str_replace_all(type, "\\)", "\\),"), # add commas to be able to separate the rows 
         riding = str_replace_all(riding, "\\)", "\\),")) %>% # again
  distinct(name, birth, gender, type, riding, province, pid) %>% # remove unecessary variables
  separate_rows(type, sep = ",", convert = TRUE) %>%  # separate rows
  separate_rows(riding, sep = ",", convert = TRUE) %>% 
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(type_date = str_extract_all(type, "\\([^()]+\\)"), # extract dates from positions
         type_date = str_extract_all(type_date, "(?<=\\().+?(?=\\))"), 
         riding_date = str_extract_all(riding, "\\([^()]+\\)"), # extract dates from ridings
         riding_date = str_extract_all(riding_date, "(?<=\\().+?(?=\\))")) %>%  
  unnest(c(type_date, riding_date)) %>% 
  mutate(dist_name = str_remove_all(riding, "\\(\\)"), # clean-up riding names
         dist_name = str_remove_all(dist_name, "\\([^()]+\\)"),
         dist_name = str_replace_all(dist_name, "--", "-")) %>%  
  filter(!str_detect(type, "Senator"), # remove senators
         type_date != 0 | riding_date != 0, # remove rows where dates are not identical
         type_date == riding_date) %>% 
  separate(riding_date, sep = "-", into = c("riding_start_date", "riding_end_date")) %>% # divide start and end dates
  mutate_all(~ str_trim(., side = "both")) %>% # clean-up
  mutate(riding_start_date = ymd(riding_start_date), # transform  to  date format
         riding_end_date = ymd(riding_end_date), # again
         riding_end_date = as.character(riding_end_date), # add end date to those who are still serving
         riding_end_date = ifelse(is.na(riding_end_date) == TRUE, "2020-04-01", riding_end_date), 
         riding_end_date = as.Date(riding_end_date)) %>% 
  filter(riding_end_date >= "2015-10-19" & riding_start_date <= "2019-09-11") %>%  # keep only those that end after the election (October 19, 2015) and those that start before the end of the 35th parliament (September 11, 2019)
  #mutate(pid = str_remove_all(pid, "\\(\\)"), # clean-up party affiliations
  #       pid = str_remove_all(pid, "\\([^()]+\\)")) %>% 
  select(-type_date, -province, -riding, -type) %>% # remove unecessary variables
  mutate(year = 2015)
  
length(unique(parl42$name))
summary(parl42)
length(unique(parl42$dist_name))
```

### 5) Merging the Census Data with the Parliament Data

We now have: 

- in one single dataset, the population's age composition in each district between 1991 and 2016 (Census data), and 
- information on MPs, their district and their date of birth in another dataset (Parliament data).

We will merge these information together by year and district name. Hopefully, the district names in the two sources will match (they won't, but it's not too bad, don't worry). First, let's keep only the census data we need, i.e. the election years. I know some MPs were elected in-between elections (by-elections), but to make things simpler we will match them with the population data of the previous general election (i.e. the start date of the parliament they are serving in).

```{r}
census_for_district <- imputation_data2 %>% 
  filter(year == 1991 | year == 1993 | year == 1997 | year == 2000 | year == 2004 |
           year == 2006 | year == 2008 | year == 2011 | year == 2015) %>% 
  filter(year ==  1991 & ro == "ro1987" |
         year ==  1993 & ro == "ro1987" |
         year ==  1997 & ro == "ro1996" |
         year ==  2000 & ro == "ro1996" |
         year ==  2004 & ro == "ro2003" |
         year ==  2006 & ro == "ro2003_2" |
         year ==  2008 & ro == "ro2003_2" |
         year ==  2011 & ro == "ro2003_2" |
         year ==  2015 & ro == "ro2013") %>% # keep good election years and representation orders
  select(year, dist_name, dist_nb, age, value) %>% 
  spread(age, value) %>% 
  separate(dist_name, sep = "\\/", into = c("dist_name", "dist_name_fr")) %>% # removing french names that are sometimes added, as such: dist_name_end/dist_name_fr
  select(-dist_name_fr) %>% 
  mutate(dist_name = str_replace_all(dist_name, "  ", " "), # remove extra space in-between words
         dist_name = str_replace_all(dist_name, " ", "-")) # make names as similar as possible to candidates data

# I will be merging each parliament dataset individually to keep track of potential mistakes
# I mentioned earlier that choosing the 1996 distirct names upon merging censuses could create problems later on. 
# Turns out the 2000 census data is not so easily merged with the parliament data because the district names are not all the same. 
# I have to manually recode the names of many districts in 2000.
# After trying to merge once, other discrepancies in spelling turned out. This is why I am re-spelling some districts here.
# This is a very manual task but I have not found any alternative.
# So far things have run relatively smoothly, so I am not too frustrated by this task.
election88 <- census_for_district %>% 
  filter(year == 1991) %>% 
  mutate(dist_name = recode(dist_name, "Laval-Est" = "Laval-East"),
         dist_name = recode(dist_name, "Laval-Ouest" = "Laval-West"),
         dist_name = recode(dist_name, "Mont-Royal" = "Mount-Royal"),
         dist_name = recode(dist_name, "Capilano-Howe-Sound" = "Capilano"))

election93 <- census_for_district %>% 
  filter(year == 1993) %>% 
  mutate(dist_name = recode(dist_name, "Laval-Est" = "Laval-East"),
         dist_name = recode(dist_name, "Laval-Ouest" = "Laval-West"),
         dist_name = recode(dist_name, "Mont-Royal" = "Mount-Royal"))

election97 <- census_for_district %>% 
  filter(year == 1997) %>% 
  mutate(dist_name = recode(dist_name, "Laval-Est" = "Laval-East"),
         dist_name = recode(dist_name, "Laval-Ouest" = "Laval-West"),
         dist_name = recode(dist_name, "Mont-Royal" = "Mount-Royal"),
         dist_name = recode(dist_name, "Québec-Est" = "Québec-East"),
         dist_name = recode(dist_name, "BramptonWest-Mississauga" = "Brampton-West-Mississauga"))

election00 <- census_for_district %>% 
  filter(year == 2000) %>% 
  mutate(dist_name = recode(dist_name, "Carleton-Gloucester" = "Ottawa-Orléans"),
         dist_name = recode(dist_name, "Verchères" = "Verchères-Les-Patriotes"),                            
         dist_name = recode(dist_name, "Rosemont" = "Rosemont-Petite-Patrie"),                            
         dist_name = recode(dist_name, "Moncton" = "Moncton-Riverview-Dieppe"),                          
         dist_name = recode(dist_name, "Wentworth-Burlington" = "Ancaster-Dundas-Flamborough-Aldershot"),           
         dist_name = recode(dist_name, "Thunder-Bay-Nipigon" = "Thunder-Bay-Superior-North"),                       
         dist_name = recode(dist_name, "Bras-d'Or" = "Bras-d'Or-Cape-Breton"),                            
         dist_name = recode(dist_name, "Lotbinière" = "Lotbinière-L'Érable"),                               
         dist_name = recode(dist_name, "Lévis" = "Lévis-et-Chutes-de-la-Chaudière"),   
         dist_name = recode(dist_name, "Verdun-Saint-Henri" = "Verdun-Saint-Henri-Saint-Paul-Pointe-Saint-Charles"), 
         dist_name = recode(dist_name, "Lac-Saint-Jean" = "Lac-Saint-Jean-Saguenay"),                            
         dist_name = recode(dist_name, "Edmonton-East" = "Edmonton-Centre-East"),                              
         dist_name = recode(dist_name, "West-Kootenay-Okanagan" = "Kootenay-Boundary-Okanagan"),                        
         dist_name = recode(dist_name, "Beauport-Montmorency-Orléans" = "Beauport-Montmorency-Côte-de-Beaupré-Île-d'Orléans"), 
         dist_name = recode(dist_name, "Charleswood-Assiniboine" = "Charleswood-St.-James-Assiniboia"),                  
         dist_name = recode(dist_name, "Chicoutimi" = "Chicoutimi-Le-Fjord"),                               
         dist_name = recode(dist_name, "Kamloops" = "Thompson-and-Highland-Valleys"),                      
         dist_name = recode(dist_name, "Bruce-Grey" = "Bruce-Grey-Owen-Sound"),                             
         dist_name = recode(dist_name, "Stormont-Dundas" = "Stormont-Dundas-Charlottenburgh"),                    
         dist_name = recode(dist_name, "Argenteuil-Papineau" = "Argenteuil-Papineau-Mirabel"),                      
         dist_name = recode(dist_name, "Bramalea-Gore-Malton" = "Bramalea-Gore-Malton-Springdale"),                    
         dist_name = recode(dist_name, "Charlesbourg" = "Charlesbourg-Jacques-Cartier"),                       
         dist_name = recode(dist_name, "Broadview-Greenwood" = "Toronto-Danforth"),                                  
         dist_name = recode(dist_name, "Port-Moody-Coquitlam" = "Port-Moody-Coquitlam-Port-Coquitlam"),               
         dist_name = recode(dist_name, "Qu'Appelle" = "Regina-Qu'Appelle"),                                  
         dist_name = recode(dist_name, "Victoria-Haliburton" = "Haliburton-Victoria-Brock"),                         
         dist_name = recode(dist_name, "Saint-Eustache-Sainte-Thérèse" = "Rivière-des-Mille-Îles"),                            
         dist_name = recode(dist_name, "Kent-Essex" = "Chatham-Kent-Essex"),                                
         dist_name = recode(dist_name, "Richelieu" = "Bas-Richelieu-Nicolet-Bécancour"),                  
         dist_name = recode(dist_name, "Abitibi" = "Abitibi-Baie-James-Nunavik"),                        
         dist_name = recode(dist_name, "Sackville-Eastern-Shore" = "Sackville-Musquodoboit-Valley-Eastern-Shore"),       
         dist_name = recode(dist_name, "Charlotte" = "New-Brunswick-Southwest"),                           
         dist_name = recode(dist_name, "Rimouski-Mitis" = "Rimouski-Neigette-et-La-Mitis"),                     
         dist_name = recode(dist_name, "Wanuskewin" = "Saskatoon-Wanuskewin"),
         dist_name = recode(dist_name, "Laval-Est" = "Laval-East"),
         dist_name = recode(dist_name, "Laval-Ouest" = "Laval-West"),
         dist_name = recode(dist_name, "Mont-Royal" = "Mount-Royal"),
         dist_name = recode(dist_name, "Québec-Est" = "Québec-East"),
         dist_name = recode(dist_name, "BramptonWest-Mississauga" = "Brampton-West-Mississauga"))

election04 <- census_for_district %>% 
  filter(year == 2004) %>% 
  mutate(dist_name = recode(dist_name, "Laurier" = "Laurier-Sainte-Marie"))

election06 <- census_for_district %>% 
  filter(year == 2006) %>% 
  mutate(dist_name = recode(dist_name, "Mont-Royal" = "Mount-Royal"),
         dist_name = recode(dist_name, "Montmagny-L'Islet-Kamouraska-Rivière-du-Loup" = "Montmagny-L’Islet-Kamouraska-Rivière-du-Loup"))

election08 <- census_for_district %>% 
  filter(year == 2008) %>% 
  mutate(dist_name = recode(dist_name, "Mont-Royal" = "Mount-Royal"),
         dist_name = recode(dist_name, "Montmagny-L'Islet-Kamouraska-Rivière-du-Loup" = "Montmagny-L’Islet-Kamouraska-Rivière-du-Loup"))

election11 <- census_for_district %>% 
  filter(year == 2011) %>% 
  mutate(dist_name = recode(dist_name, "Mont-Royal" = "Mount-Royal"),
         dist_name = recode(dist_name, "Montmagny-L'Islet-Kamouraska-Rivière-du-Loup" = "Montmagny-L’Islet-Kamouraska-Rivière-du-Loup"))

election15 <- census_for_district %>% 
  filter(year == 2015) %>% 
  mutate(dist_name = recode(dist_name, "Beauport-Côte-de-Beaupré-Île-d'Orléans-Charlevoix" = "Beauport-Côte-de-Beaupré-Île-D’Orléans-Charlevoix"),
         dist_name = recode(dist_name, "Montmagny-L'Islet-Kamouraska-Rivière-du-Loup" = "Montmagny-L’Islet-Kamouraska-Rivière-du-Loup"))

# make district names as similar as possible to districts in the census data
parl34 <- parl34 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl35 <- parl35 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl36 <- parl36 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl37 <- parl37 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl38 <- parl38 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl39 <- parl39 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl40 <- parl40 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl41 <- parl41 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))
parl42 <- parl42 %>% mutate(dist_name = str_replace_all(dist_name, " ", "-"))

```

FINAL step: Merging it all together! I tried using `stringdist_left_join()` to make things quicker and match districts that were closely-spelled, but I noticed it introduced some mistakes. For example, districts that included 'East', 'West', 'Southeast', 'Southwest' would be present more than once after merging. I want a dataset that's as clean as possible so I prefer doing it manually and renaming the districts that are spelled differently.

```{r}
join34 <- left_join(parl34, election88)
length(unique(join34$dist_name))
check <- join34 %>% filter(is.na(dist_nb)==TRUE)# it worked 

join35 <- left_join(parl35, election93)
length(unique(join35$dist_name))
check <- join35 %>% filter(is.na(dist_nb)==TRUE)# it worked 

join36 <- left_join(parl36, election97)
length(unique(join36$dist_name))
check <- join36 %>% filter(is.na(dist_nb)==TRUE) # it worked 

join37 <- left_join(parl37, election00)
length(unique(join37$dist_name))
check <- join37 %>% filter(is.na(dist_nb)==TRUE) # all good

join38 <- left_join(parl38, election04)
length(unique(join38$dist_name))
check <- join38 %>% filter(is.na(dist_nb)==TRUE) ## all good

join39 <- left_join(parl39, election06)
length(unique(join39$dist_name))
check <- join39 %>% filter(is.na(dist_nb)==TRUE) # perfect

join40 <- left_join(parl40, election08)
length(unique(join40$dist_name))
check <- join40 %>% filter(is.na(dist_nb)==TRUE) # yes!

join41 <- left_join(parl41, election11)
length(unique(join41$dist_name))
check <- join41 %>% filter(is.na(dist_nb)==TRUE) # nearly there, one left

join42 <- left_join(parl42, election15)
length(unique(join42$dist_name))
check <- join42 %>% filter(is.na(dist_nb)==TRUE) # yes yes yes

d <- full_join(join34, join35) %>% 
  full_join(join36) %>% 
  full_join(join37) %>% 
  full_join(join38) %>% 
  full_join(join39) %>% 
  full_join(join40) %>% 
  full_join(join41) %>% 
  full_join(join42)

write.csv(d, file = "documentation/data/output/census_parliament.csv")
```

And, that's a wrap! There is an observation for every MP elected in the House between 1988 and 2015. The 1991 census information is used for the 34th parliament (1988-1993) because we did not have census data prior to 1991. Every age group is its own variable (columns), from 0 to 100. Note that the 1991 and 1996 censuses capped the age groups at 90 years old. Those older were categorized as 90 year olds. This is why there are no values in the 90-100 variables for the years 1991 to 2000, which were all imputed using the 1991 or 1996 censuses. The party affiliation variable is not clean yet, but it's on my to-do list, so stay tuned!